<html>
<head>
</head>
<body>

    <table>
        <thead>
            <tr>
                <th>Block</th>
                <th>Date Mined</th>
                <th>Status</th>
                <th>Block Reward</th>
            </tr>
        </thead>
        <tbody id="block-table">
            
        </tbody>
    </table>
    <div id="pageination">Block data loading...</div>
</body>
</html>

<script>
    var blockRows = [];

    async function getBlockInfo() {

        let response = await fetch('http://tulipfarm.one:2127/payout/block/info');
        
        let blockInfo = await response.json();
        let jsonBlockInfo = JSON.parse(blockInfo);

        let blockInfoLength = Object.keys(jsonBlockInfo).length - 1;
        
        var blockDate; 
        var blockReward;
        var blockStatus;

        Object.keys(jsonBlockInfo).forEach(blockNum => {
            blockDate = new Date(jsonBlockInfo[blockNum].timestamp);
            blockReward = jsonBlockInfo[blockNum].rewardAmount_sat / 1000000000;
            blockStatus = jsonBlockInfo[blockNum].shareType;

            if (blockStatus == 'round') {
                blockStatus = 'Pending';
            }
            else {
                blockStatus = 'Confirmed';
            }
            blockRows[blockInfoLength] = '<tr>\
                <td>' + blockNum + '</td>\
                <td>' + blockDate.toLocaleString('en-us')  + '</td>\
                <td>' + blockStatus + '</td>\
                <td>' + blockReward + '</td>\
                </tr>';
            blockInfoLength--;
        });
        
        return blockRows;
    }


    var current_page = 1;
    var records_per_page = 10;

    getBlockInfo()
        .then((blockRows) => {

                        
            var htmlString = '<a href="javascript:prevPage()" id="btn_prev">Prev</a>\
            <a href="javascript:nextPage()" id="btn_next">Next</a>\
            page: <span id="page"></span>';
            // for(var i = 0; i < blockRows.length; i++)
            //   htmlString += blockRows[i];
            document.getElementById('pageination').innerHTML = htmlString;
            changePage(1);
            return blockRows;
        });

    function changePage(page){
            var btn_next = document.getElementById("btn_next");
            var btn_prev = document.getElementById("btn_prev");
            var listing_table = document.getElementById("block-table");
            var page_span = document.getElementById("page");
        
            // Validate page
            if (page < 1) page = 1;
            if (page > numPages()) page = numPages();

            listing_table.innerHTML = "";

            for (var i = (page-1) * records_per_page; i < (page * records_per_page) && i < blockRows.length; i++) {
                listing_table.innerHTML += blockRows[i];
            }
            page_span.innerHTML = page + "/" + numPages();

            if (page == 1) {
                btn_prev.style.visibility = "hidden";
            } else {
                btn_prev.style.visibility = "visible";
            }

            if (page == numPages()) {
                btn_next.style.visibility = "hidden";
            } else {
                btn_next.style.visibility = "visible";
            }
        }

    function numPages(){
        return Math.ceil(blockRows.length / records_per_page);
    }

    function prevPage(){
        if (current_page > 1) {
            current_page--;
            changePage(current_page);
        }
    }

    function nextPage(){
        if (current_page < numPages()) {
            current_page++;
            changePage(current_page);
        }
    }
</script>
